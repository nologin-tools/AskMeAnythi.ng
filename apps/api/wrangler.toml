name = "askmeanything-api"
main = "src/index.ts"
compatibility_date = "2024-11-01"
compatibility_flags = ["nodejs_compat"]

[vars]
ENVIRONMENT = "development"

# D1 Database
[[d1_databases]]
binding = "DB"
database_name = "askmeanything-db"
database_id = "local"

# Durable Objects
[durable_objects]
bindings = [
  { name = "SESSION_ROOM", class_name = "SessionRoom" }
]

[[migrations]]
tag = "v1"
new_sqlite_classes = ["SessionRoom"]

# KV Namespace (for rate limiting and caching)
[[kv_namespaces]]
binding = "CACHE"
id = "local-kv"

# Cron Triggers (for cleanup)
# [triggers]
# crons = ["0 3 * * *"]  # 每天凌晨3点

[dev]
port = 8787

# Production environment
[env.production]
vars = { ENVIRONMENT = "production" }
routes = [
  { pattern = "askmeanythi.ng/api/*", zone_name = "askmeanythi.ng" },
  { pattern = "askmeanythi.ng/ws/*", zone_name = "askmeanythi.ng" }
]

[env.production.durable_objects]
bindings = [
  { name = "SESSION_ROOM", class_name = "SessionRoom" }
]

[[env.production.migrations]]
tag = "v1"
new_sqlite_classes = ["SessionRoom"]

[[env.production.d1_databases]]
binding = "DB"
database_name = "askmeanything-db"
database_id = "c98648ff-3ac8-4569-ab46-c6ba1e356372"

[[env.production.kv_namespaces]]
binding = "CACHE"
id = "6ee3765161684def887c01ada9bc4e3d"

[env.production.triggers]
crons = ["0 3 * * *"]
