name: CI / Deploy

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  # ── Job 1: Lint + Build (PR and push) ──
  check:
    name: Lint & Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm lint
      - run: pnpm build
      - uses: actions/upload-artifact@v4
        if: github.event_name == 'push'
        with:
          name: web-dist
          path: apps/web/dist
          retention-days: 1

  # ── Job 2: Deploy API (push to main only) ──
  deploy-api:
    name: Deploy API
    needs: check
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - name: Run D1 migrations
        working-directory: apps/api
        run: |
          npx wrangler d1 execute askmeanything-db --remote --env production --file=./src/db/schema.sql
          npx wrangler d1 execute askmeanything-db --remote --env production --file=./src/db/0001_add_question_limits.sql
          npx wrangler d1 execute askmeanything-db --remote --env production --file=./src/db/0002_add_rate_limits.sql
          npx wrangler d1 execute askmeanything-db --remote --env production --file=./src/db/0003_add_server_fingerprint.sql
          npx wrangler d1 execute askmeanything-db --remote --env production --file=./src/db/0004_add_reports.sql
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      - name: Deploy to Cloudflare Workers
        working-directory: apps/api
        run: npx wrangler deploy --env production
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

  # ── Job 3: Deploy Web (push to main only, parallel with API) ──
  deploy-web:
    name: Deploy Web
    needs: check
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - uses: actions/download-artifact@v4
        with:
          name: web-dist
          path: apps/web/dist
      - name: Create Pages project (if not exists)
        run: npx wrangler pages project create askmeanything-web --production-branch=main || true
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      - name: Deploy to Cloudflare Pages
        run: npx wrangler pages deploy apps/web/dist --project-name=askmeanything-web
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
